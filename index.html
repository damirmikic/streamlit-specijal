<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Odds Exporter</title>
    <!-- FAVICON - Ovde unesite link do vaše ikonice na GitHub-u -->
    <link rel="icon" type="image/png" href="https://vaš-link-do-slike-na-githubu/merkur.png">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A simple spinning animation for the loader */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        /* Style for disabled elements */
        select:disabled, button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Styles for the tabs */
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Football Odds Exporter</h1>
            <p class="text-gray-600 mt-2">Select a league and match to fetch available markets and download them as a CSV file.</p>
        </header>

        <main class="bg-white rounded-lg shadow-md p-6">
            <!-- Dropdown Selection Area -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="leagueSelect" class="block text-sm font-medium text-gray-700">1. Select League</label>
                    <select id="leagueSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">-- Choose a League --</option>
                    </select>
                </div>
                 <div>
                    <label for="matchSelect" class="block text-sm font-medium text-gray-700">2. Select Match</label>
                    <select id="matchSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" disabled>
                        <option value="">-- Waiting for League --</option>
                    </select>
                </div>
                <div class="flex items-center gap-4">
                     <button id="fetchMarketsButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" disabled>
                        Fetch Markets
                    </button>
                    <div id="loader" class="hidden spinner"></div>
                </div>
            </div>
            
            <!-- New Player Props CSV Generator Section -->
            <div id="playerCsvGeneratorSection" class="mt-8 pt-6 border-t border-gray-200 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Player Props CSV Generator</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="teamSelect" class="block text-sm font-medium text-gray-700">3. Select Team</label>
                        <select id="teamSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="">-- Select a team --</option>
                        </select>
                    </div>
                    <div>
                        <label for="playerSelect" class="block text-sm font-medium text-gray-700">4. Select Player</label>
                         <div class="flex">
                            <select id="playerSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" disabled>
                                <option value="">-- Select a player --</option>
                            </select>
                            <button id="addPlayerButton" class="ml-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-lg" disabled>+</button>
                        </div>
                    </div>
                </div>
                 <div class="flex flex-col md:flex-row gap-4 mt-4">
                    <button id="previewPlayerCsvButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300" disabled>
                        Napravi Pregled (Preview)
                    </button>
                    <button id="clearPlayersButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300" disabled>
                        Poništi Unos i Očisti Igrače
                    </button>
                </div>
                 <div class="mt-4">
                    <h4 class="font-semibold">Selected Players:</h4>
                    <ul id="selectedPlayersList" class="list-disc list-inside bg-gray-50 p-3 rounded-md min-h-[40px]">
                        <!-- Selected players will be listed here -->
                    </ul>
                </div>
            </div>
            
            <!-- CSV Preview and Final Generation Section -->
            <div id="csvPreviewSection" class="mt-8 pt-6 border-t-2 border-indigo-200 hidden">
                 <h2 class="text-2xl font-bold text-indigo-800 mb-4">Pregled i Izmena CSV-a</h2>
                 <div id="csvPreviewContent" class="space-y-6">
                     <!-- Preview content will be generated here -->
                 </div>
                 <div class="mt-6 text-right">
                     <button id="generateFinalCsvButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                         Generiši Finalni CSV
                     </button>
                 </div>
            </div>


             <!-- Download Button Area (for all markets) -->
            <div id="downloadContainer" class="mt-4 text-right hidden">
                 <button id="downloadCsvButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                    Download All Markets as CSV
                </button>
            </div>

            <!-- Status/Log Area -->
            <div id="status" class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 h-32 overflow-y-auto">
                Please select a league to begin.
            </div>

            <!-- Raw Data Display -->
            <div class="mt-4">
                <button id="toggleRawDataButton" class="text-sm text-blue-600 hover:underline focus:outline-none hidden">Show/Hide Raw API Response</button>
            </div>
            <div id="rawDataContainer" class="hidden mt-4">
                <h3 class="text-lg font-semibold text-gray-700">Raw JSON Data</h3>
                <pre class="bg-gray-800 text-white p-4 rounded-lg text-xs overflow-x-auto max-h-96">
                    <code id="rawDataOutput"></code>
                </pre>
            </div>

            <!-- Tabs Navigation -->
            <div class="mt-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button id="main-tab" class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Main Markets</button>
                    <button id="stats-tab" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700">Stat Markets</button>
                    <button id="player-tab" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700">Player Props</button>
                    <button id="match-specials-tab" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700">Meč Specijal</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content" class="mt-4">
                <!-- Main Markets Table -->
                <div id="main-content" class="tab-panel">
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Market</th>
                                    <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Selection</th>
                                    <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Odds</th>
                                </tr>
                            </thead>
                            <tbody id="mainTableBody">
                                <tr><td colspan="3" class="text-center py-4 text-gray-500">No data fetched yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Stats Markets Table -->
                <div id="stats-content" class="tab-panel hidden">
                     <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Market</th>
                                    <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Selection</th>
                                    <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Odds</th>
                                </tr>
                            </thead>
                            <tbody id="statsTableBody">
                               <tr><td colspan="3" class="text-center py-4 text-gray-500">No data fetched yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Player Props Table -->
                <div id="player-content" class="tab-panel hidden">
                    <div>
                        <h3 id="homeTeamHeader" class="text-xl font-semibold text-gray-800 mb-2"></h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tržište (Market)</th>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Igrač i opklada (Selection)</th>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kvota (Odds)</th>
                                    </tr>
                                </thead>
                                <tbody id="homePlayerTableBody">
                                    <!-- Populated by script -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h3 id="awayTeamHeader" class="text-xl font-semibold text-gray-800 mb-2"></h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                     <tr>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tržište (Market)</th>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Igrač i opklada (Selection)</th>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kvota (Odds)</th>
                                    </tr>
                                </thead>
                                <tbody id="awayPlayerTableBody">
                                    <!-- Populated by script -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                 <!-- Match Specials Tab -->
                <div id="match-specials-content" class="tab-panel hidden">
                    <div class="text-center">
                        <p class="text-gray-700 mb-4">Otvorite stranicu sa specijalima za izabrani meč.</p>
                        <button id="openMatchSpecialsButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300" disabled>
                            Otvori Specijale za Meč
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const LEAGUE_URLS = {
            "Premier League": "https://eu-offering-api.kambicdn.com/offering/v2018/ilaniuswarl/listView/football/england/premier_league/all/matches.json?lang=en_GB&market=GB&useCombined=true",
            "La Liga": "https://eu-offering-api.kambicdn.com/offering/v2018/ilaniuswarl/listView/football/spain/la_liga/all/matches.json?lang=en_GB&market=GB&useCombined=true",
            "Serie A": "https://eu-offering-api.kambicdn.com/offering/v2018/ilaniuswarl/listView/football/italy/serie_a/all/matches.json?lang=en_GB&market=GB&useCombined=true",
            "Bundesliga": "https://eu-offering-api.kambicdn.com/offering/v2018/ilaniuswarl/listView/football/germany/bundesliga/all/matches.json?lang=en_GB&market=GB&useCombined=true",
            "Ligue 1": "https://eu-offering-api.kambicdn.com/offering/v2018/ilaniuswarl/listView/football/france/ligue_1/all/matches.json?lang=en_GB&market=GB&useCombined=true",
            "Champions League": "https://eu1.offering-api.kambicdn.com/offering/v2018/ilaniuswarl/listView/football/champions_league/all/all/matches.json?channel_id=7&client_id=2&lang=en_GB&market=GB&useCombined=true",
            "Europa League": "https://eu1.offering-api.kambicdn.com/offering/v2018/ilaniuswarl/listView/football/europa_league/all/all/matches.json?channel_id=7&client_id=2&lang=en_GB&market=GB&useCombined=true",
        };
        
        let allMarketDataForCSV = [];
        let fetchedMarketData = null; // Store fetched data
        let selectedPlayersForCSV = []; // Store players for special CSV
        let previewData = []; // Data for the CSV preview, can be edited

        // DOM Elements
        const leagueSelect = document.getElementById('leagueSelect');
        const matchSelect = document.getElementById('matchSelect');
        const fetchMarketsButton = document.getElementById('fetchMarketsButton');
        const downloadContainer = document.getElementById('downloadContainer');
        const downloadCsvButton = document.getElementById('downloadCsvButton');
        const statusDiv = document.getElementById('status');
        const loader = document.getElementById('loader');
        const toggleRawDataButton = document.getElementById('toggleRawDataButton');
        const rawDataContainer = document.getElementById('rawDataContainer');
        const rawDataOutput = document.getElementById('rawDataOutput');
        
        const mainTableBody = document.getElementById('mainTableBody');
        const statsTableBody = document.getElementById('statsTableBody');
        const homePlayerTableBody = document.getElementById('homePlayerTableBody');
        const awayPlayerTableBody = document.getElementById('awayPlayerTableBody');
        const homeTeamHeader = document.getElementById('homeTeamHeader');
        const awayTeamHeader = document.getElementById('awayTeamHeader');

        const playerCsvGeneratorSection = document.getElementById('playerCsvGeneratorSection');
        const teamSelect = document.getElementById('teamSelect');
        const playerSelect = document.getElementById('playerSelect');
        const addPlayerButton = document.getElementById('addPlayerButton');
        const selectedPlayersList = document.getElementById('selectedPlayersList');
        const previewPlayerCsvButton = document.getElementById('previewPlayerCsvButton');
        const clearPlayersButton = document.getElementById('clearPlayersButton');

        const csvPreviewSection = document.getElementById('csvPreviewSection');
        const csvPreviewContent = document.getElementById('csvPreviewContent');
        const generateFinalCsvButton = document.getElementById('generateFinalCsvButton');
        
        const openMatchSpecialsButton = document.getElementById('openMatchSpecialsButton');

        const tabs = document.querySelectorAll('.tab-button');
        const tabPanels = document.querySelectorAll('.tab-panel');

        // --- Utility Functions ---
        function logStatus(message, isError = false) {
            const now = new Date().toLocaleTimeString();
            const color = isError ? 'text-red-500' : 'text-gray-800';
            statusDiv.innerHTML = `<div class="${color}">[${now}] ${message}</div>` + statusDiv.innerHTML;
        }

        function toggleLoading(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }
        
        function removeDiacritics(text) {
             if (!text) return '';
            text = text.replace(/đ/g, 'dj').replace(/Đ/g, 'Dj');
            return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        /**
         * Converts an array of objects to a CSV string.
         * @param {Array<Object>} data - The array of objects to convert.
         * @param {Array<string>} columns - The columns to include in the CSV.
         * @returns {string} The CSV string.
         */
        function arrayToCsv(data, columns) {
            const header = columns.join(',');
            const rows = data.map(obj => {
                return columns.map(col => {
                    let value = obj[col] === undefined || obj[col] === null ? '' : String(obj[col]);
                    // Escape commas and quotes
                    if (value.includes(',') || value.includes('"')) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',');
            });
            return [header, ...rows].join('\n');
        }

        // --- Core Logic ---

        // 1. Populate Leagues on page load
        function populateLeagues() {
            for (const leagueName in LEAGUE_URLS) {
                const option = document.createElement('option');
                option.value = leagueName;
                option.textContent = leagueName;
                leagueSelect.appendChild(option);
            }
        }
        
        function resetTables() {
            const placeholder = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Select a match to see markets.</td></tr>';
            mainTableBody.innerHTML = placeholder;
            statsTableBody.innerHTML = placeholder;
            homePlayerTableBody.innerHTML = placeholder;
            awayPlayerTableBody.innerHTML = placeholder;
            homeTeamHeader.textContent = '';
            awayTeamHeader.textContent = '';
            csvPreviewSection.classList.add('hidden');
        }

        // 2. Fetch matches when a league is selected
        async function fetchMatchesForLeague(leagueName) {
            // Reset state
            matchSelect.innerHTML = '<option value="">-- Fetching Matches --</option>';
            matchSelect.disabled = true;
            fetchMarketsButton.disabled = true;
            resetTables();
            downloadContainer.classList.add('hidden');
            playerCsvGeneratorSection.classList.add('hidden');
            allMarketDataForCSV = [];
            fetchedMarketData = null;
            toggleRawDataButton.classList.add('hidden');
            rawDataContainer.classList.add('hidden');
            rawDataOutput.textContent = '';
            openMatchSpecialsButton.disabled = true;

            if (!leagueName) {
                matchSelect.innerHTML = '<option value="">-- Waiting for League --</option>';
                return;
            }
            
            const url = LEAGUE_URLS[leagueName];
            logStatus(`Fetching matches for ${leagueName}...`);
            toggleLoading(true);

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                matchSelect.innerHTML = '<option value="">-- Select a Match --</option>';
                if (data.events && data.events.length > 0) {
                    data.events.forEach(event => {
                        const option = document.createElement('option');
                        option.value = event.event.id;
                        option.textContent = `${event.event.homeName} vs ${event.event.awayName}`;
                        matchSelect.appendChild(option);
                    });
                    matchSelect.disabled = false;
                    logStatus(`Successfully found ${data.events.length} matches for ${leagueName}.`);
                } else {
                     matchSelect.innerHTML = '<option value="">-- No Matches Found --</option>';
                     logStatus(`No matches found for ${leagueName}.`, true);
                }
            } catch (error) {
                logStatus(`Failed to fetch matches for ${leagueName}: ${error.message}`, true);
                matchSelect.innerHTML = '<option value="">-- Error Fetching --</option>';
            } finally {
                toggleLoading(false);
            }
        }

        // 3. Fetch, categorize, and display all markets for the selected match
        async function fetchAndDisplayMarkets() {
            const eventId = matchSelect.value;
            if (!eventId) return;

            logStatus(`Fetching all markets for event ID: ${eventId}...`);
            toggleLoading(true);
            fetchMarketsButton.disabled = true;
            mainTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Fetching markets...</td></tr>';
            statsTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Fetching markets...</td></tr>';
            homePlayerTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Fetching markets...</td></tr>';
            awayPlayerTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Fetching markets...</td></tr>';
            downloadContainer.classList.add('hidden');
            playerCsvGeneratorSection.classList.add('hidden');
            csvPreviewSection.classList.add('hidden');
            toggleRawDataButton.classList.add('hidden');
            rawDataContainer.classList.add('hidden');
            
            const oddsUrl = `https://eu1.offering-api.kambicdn.com/offering/v2018/ilaniuswarl/betoffer/event/${eventId}.json?lang=en_GB&market=GB&client_id=2&channel_id=7&includeParticipants=true`;

            try {
                const response = await fetch(oddsUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                fetchedMarketData = data; // Store the data
                sessionStorage.setItem(`event_${eventId}`, JSON.stringify(data)); // Save to session storage
                openMatchSpecialsButton.disabled = false;


                // Display raw data
                rawDataOutput.textContent = JSON.stringify(data, null, 2);
                toggleRawDataButton.classList.remove('hidden');
                
                const allBetOffers = data.betOffers;
                if (!allBetOffers || allBetOffers.length === 0) {
                    logStatus('Successfully fetched match data, but no markets were found.', true);
                    resetTables();
                    mainTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">No markets found. You can inspect the Raw API Response above.</td></tr>`;
                    return; 
                }
                
                // Serbian translations for player prop markets
                const serbianTranslations = {
                    "To Score": "Daje gol",
                    "To Get a Card": "Dobija karton",
                    "First Goal Scorer": "Prvi strelac",
                    "Player's shots on target (Settled using Opta data)": "Šutevi u okvir gola",
                    "To Assist (Settled using Opta data)": "Asistencija",
                    "To score or get an assist": "Gol ili asistencija",
                    "To Score or Assist": "Gol ili asistencija",
                    "To Score Or Assist (Settled using Opta data)": "Gol ili asistencija",
                    "To score at least 2 goals": "Daje 2+ gola",
                    "To score at least 3 goals": "Daje 3+ gola (Het-trik)",
                    "To score from a header": "Daje gol glavom",
                    "To score from outside the penalty box": "Daje gol izvan šesnaesterca",
                    "Player's shots (Settled using Opta data)": "Ukupno šuteva",
                    "To Get a Red Card": "Dobija crveni karton",
                    "Player's fouls conceded (Settled using Opta data)": "Načinjenih faulova"
                };

                let participantMap = new Map();
                let homeTeam = null;
                let awayTeam = null;
                
                if (data.events && data.events.length > 0 && data.events[0].participants) {
                     data.events[0].participants.forEach(p => {
                        participantMap.set(p.participantId, p.name);
                        if (p.home) homeTeam = { id: p.participantId, name: p.name };
                        else awayTeam = { id: p.participantId, name: p.name };
                    });
                }
                
                // Arrays for categorizing data
                let mainMarkets = [];
                let statMarkets = [];
                let playerMarkets = [];
                allMarketDataForCSV = [];

                allBetOffers.forEach(offer => {
                    const marketName = offer.criterion.label;
                    const marketNameLower = marketName.toLowerCase();
                    let category;

                    const isPlayerProp = offer.betOfferType.name.toLowerCase().includes('player');

                    // Categorization Logic
                    if (isPlayerProp) {
                        category = 'Player Props';
                    } else if (marketNameLower.includes('corners') || marketNameLower.includes('cards') || marketNameLower.includes('shots')) {
                        category = 'Stat Markets';
                    } else {
                        category = 'Main Markets';
                    }
                    
                    offer.outcomes.forEach(outcome => {
                        let selectionName = outcome.label;
                        let teamNameForPlayer = '';
                        
                        if (isPlayerProp) {
                            if (outcome.eventParticipantId) {
                                teamNameForPlayer = participantMap.get(outcome.eventParticipantId) || '';
                            }
                            if (outcome.participant) { // participant is player name
                                selectionName = `${outcome.participant} - ${outcome.label}`;
                            }
                        } else { // Team-level markets
                            if (outcome.participant) {
                                selectionName = outcome.participant;
                            }
                        }

                        const lineValue = (outcome.line !== undefined && outcome.line !== null) ? (outcome.line / 1000) : null;

                        if (lineValue !== null) {
                            const formattedLine = parseFloat(lineValue).toString();
                            selectionName = `${selectionName} ${formattedLine}`;
                        }
                        
                        const translatedMarketName = isPlayerProp ? (serbianTranslations[marketName] || marketName) : marketName;

                        const marketData = {
                            Category: category,
                            Market: translatedMarketName,
                            OriginalMarket: marketName,
                            Selection: selectionName,
                            Odds: (outcome.odds / 1000).toFixed(2),
                            Team: teamNameForPlayer,
                            PlayerName: isPlayerProp ? outcome.participant : null,
                            Line: lineValue,
                            Label: outcome.label
                        };

                        if (category === 'Main Markets') mainMarkets.push(marketData);
                        else if (category === 'Stat Markets') statMarkets.push(marketData);
                        else if (category === 'Player Props') playerMarkets.push(marketData);
                        
                        allMarketDataForCSV.push(marketData);
                    });
                });
                
                populateTable(mainMarkets, mainTableBody);
                populateTable(statMarkets, statsTableBody);
                
                // Populate player tables separately by team
                if(homeTeam && awayTeam) {
                    homeTeamHeader.textContent = homeTeam.name;
                    awayTeamHeader.textContent = awayTeam.name;

                    const homePlayerMarkets = playerMarkets.filter(p => p.Team === homeTeam.name);
                    const awayPlayerMarkets = playerMarkets.filter(p => p.Team === awayTeam.name);
                    
                    populateTable(homePlayerMarkets, homePlayerTableBody);
                    populateTable(awayPlayerMarkets, awayPlayerTableBody);
                } else {
                    populateTable(playerMarkets, homePlayerTableBody); // Fallback
                }

                setupPlayerCsvGenerator();

                logStatus(`Successfully categorized markets. Main: ${mainMarkets.length}, Stats: ${statMarkets.length}, Player: ${playerMarkets.length}.`);
                if (allMarketDataForCSV.length > 0) {
                     downloadContainer.classList.remove('hidden');
                }

            } catch (error) {
                logStatus(`Error fetching markets: ${error.message}`, true);
                resetTables();
                mainTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">${error.message}</td></tr>`;
            } finally {
                toggleLoading(false);
                fetchMarketsButton.disabled = false;
            }
        }

        // 4. Populate a specific table with data
        function populateTable(data, tableBodyElement) {
            const emptyMessage = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No markets of this type were found.</td></tr>';
            if (!data || data.length === 0) {
                 tableBodyElement.innerHTML = emptyMessage;
                 return;
            }
            tableBodyElement.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-3 px-4 border-b border-gray-200 text-sm">${row.Market}</td>
                    <td class="py-3 px-4 border-b border-gray-200 text-sm">${row.Selection}</td>
                    <td class="py-3 px-4 border-b border-gray-200 text-sm font-medium">${row.Odds}</td>
                `;
                tableBodyElement.appendChild(tr);
            });
        }

        // 5. Generate and trigger CSV download
        function downloadCSV(csvContent, fileName) {
            // Add BOM for UTF-8 encoding to support special characters in Excel
            const BOM = "\uFEFF";
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function handleAllMarketsDownload() {
            if (allMarketDataForCSV.length === 0) {
                logStatus('No data available to download.', true);
                return;
            }
            logStatus('Generating CSV file for all markets...');
            const columns = ["Category", "Market", "Selection", "Odds"];
            const csv = arrayToCsv(allMarketDataForCSV, columns);
            
            const leagueName = leagueSelect.value.replace(/ /g, '_');
            const matchName = matchSelect.options[matchSelect.selectedIndex].text.replace(/ /g, '_');
            const date = new Date().toISOString().slice(0, 10);
            const fileName = `markets_${leagueName}_${matchName}_${date}.csv`;

            downloadCSV(csv, fileName);
            logStatus('CSV download for all markets initiated!');
        }

        
        // 6. Handle Tab switching
        function handleTabClick(e) {
            tabs.forEach(tab => {
                tab.classList.remove('active');
                tab.classList.replace('text-gray-800', 'text-gray-500');
            });
            e.target.classList.add('active');
            e.target.classList.replace('text-gray-500', 'text-gray-800');

            tabPanels.forEach(panel => {
                panel.classList.add('hidden');
            });
            
            const targetPanelId = e.target.id.replace('-tab', '-content');
            document.getElementById(targetPanelId).classList.remove('hidden');
        }

        // --- Player Props Special CSV Generator ---
        function setupPlayerCsvGenerator() {
            playerCsvGeneratorSection.classList.remove('hidden');
            selectedPlayersForCSV = [];
            updateSelectedPlayersList();

            const { events } = fetchedMarketData;
            if (!events || events.length === 0) return;

            const homeTeam = events[0].participants.find(p => p.home);
            const awayTeam = events[0].participants.find(p => !p.home);

            teamSelect.innerHTML = `
                <option value="">-- Select a team --</option>
                <option value="${homeTeam.participantId}">${homeTeam.name}</option>
                <option value="${awayTeam.participantId}">${awayTeam.name}</option>
            `;
        }
        
        function populatePlayersForTeam(teamId) {
            playerSelect.innerHTML = '<option value="">-- Select a player --</option>';
            playerSelect.disabled = true;
            addPlayerButton.disabled = true;
            if (!teamId) return;
            
            const teamParticipantId = parseInt(teamId, 10);
            const teamName = fetchedMarketData.events[0].participants.find(p => p.participantId === teamParticipantId)?.name;
            const teamPlayerMarkets = allMarketDataForCSV.filter(d => d.PlayerName && d.Team === teamName);
            const teamPlayers = [...new Set(teamPlayerMarkets.map(p => p.PlayerName))];

            if (teamPlayers.length > 0) {
                 teamPlayers.sort().forEach(playerName => {
                    const option = document.createElement('option');
                    option.value = playerName;
                    option.textContent = playerName;
                    playerSelect.appendChild(option);
                });
                playerSelect.disabled = false;
            }
        }

        function handleAddPlayer() {
            const playerName = playerSelect.value;
            const teamId = teamSelect.value;
            const teamName = teamSelect.options[teamSelect.selectedIndex].text;

            if (playerName && teamId && !selectedPlayersForCSV.some(p => p.name === playerName)) {
                selectedPlayersForCSV.push({ name: playerName, teamName: teamName });
                updateSelectedPlayersList();
            }
        }
        
        function updateSelectedPlayersList() {
            selectedPlayersList.innerHTML = '';
            if (selectedPlayersForCSV.length === 0) {
                selectedPlayersList.innerHTML = '<li class="text-gray-500">No players added yet.</li>';
                previewPlayerCsvButton.disabled = true;
                clearPlayersButton.disabled = true;
            } else {
                 selectedPlayersForCSV.forEach((player, index) => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center py-1";
                    li.textContent = `${player.name} (${player.teamName})`;
                    const removeButton = document.createElement('button');
                    removeButton.textContent = 'x';
                    removeButton.className = 'ml-4 text-red-500 font-bold hover:text-red-700';
                    removeButton.onclick = () => {
                        selectedPlayersForCSV.splice(index, 1);
                        updateSelectedPlayersList();
                        // Hide preview if no players are left
                        if (selectedPlayersForCSV.length === 0) {
                            csvPreviewSection.classList.add('hidden');
                        }
                    };
                    li.appendChild(removeButton);
                    selectedPlayersList.appendChild(li);
                });
                previewPlayerCsvButton.disabled = false;
                clearPlayersButton.disabled = false;
            }
        }
        
        const marketSortOrder = [
            'daje gol',
            'daje gol i tim pobeđuje',
            'daje 2+ gola',
            'daje gol izvan 16m',
            'daje gol glavom',
            'asistencija',
            'gol ili asistencija',
            'ukupno šuteva 1+',
            'ukupno šuteva 2+',
            'ukupno šuteva 3+',
            'ukupno šuteva 4+',
            'šutevi u okvir gola 1+',
            'šutevi u okvir gola 2+',
            'šutevi u okvir gola 3+',
            'ukupno načinjenih faulova 1+',
            'ukupno načinjenih faulova 2+',
            'dobija karton',
            'dobija crveni karton'
        ];

        function showCsvPreview() {
            if (selectedPlayersForCSV.length === 0) {
                logStatus("Please add players to the list before creating a preview.", true);
                return;
            }

            const originalMarketToColumnMap = {
                'To Assist (Settled using Opta data)': 'asistencija',
                'To Score': 'daje gol',
                'To Score or Assist': 'gol ili asistencija',
                'To score or get an assist': 'gol ili asistencija',
                'To Score Or Assist (Settled using Opta data)': 'gol ili asistencija',
                'To Get a Card': 'dobija karton',
                'To Get a Red Card': 'dobija crveni karton',
                "Player's fouls conceded (Settled using Opta data)": 'faulovi',
                'To score at least 2 goals': 'daje 2+ gola',
                'To score from outside the penalty box': 'daje gol izvan 16m',
                "Player's shots (Settled using Opta data)": 'sutevi',
                "Player's shots on target (Settled using Opta data)": 'sutevi_u_okvir',
                'To score from a header': 'daje gol glavom'
            };
            
            previewData = []; // Reset and rebuild preview data
            
            selectedPlayersForCSV.forEach(playerInfo => {
                const playerMarkets = allMarketDataForCSV.filter(m => m.PlayerName === playerInfo.name);
                let markets = {};
                 playerMarkets.forEach(market => {
                    const oddValue = parseFloat(market.Odds);
                    if (oddValue < 1.1 || oddValue > 40) return; // Skip odds outside the range

                    const columnName = originalMarketToColumnMap[market.OriginalMarket];
                    const isOver = market.Label.toLowerCase() === 'over' || market.Label.toLowerCase() === 'yes';
                    if (!isOver && market.Line !== null) return;
                    
                    let key;
                    if (columnName === 'faulovi') {
                        if (market.Line === 1.5) key = 'ukupno načinjenih faulova 2+';
                        if (market.Line === 0.5) key = 'ukupno načinjenih faulova 1+';
                    } else if (columnName === 'sutevi') {
                        if (market.Line === 0.5) key = 'ukupno šuteva 1+';
                        if (market.Line === 1.5) key = 'ukupno šuteva 2+';
                        if (market.Line === 2.5) key = 'ukupno šuteva 3+';
                        if (market.Line === 3.5) key = 'ukupno šuteva 4+';
                    } else if (columnName === 'sutevi_u_okvir') {
                        if (market.Line === 0.5) key = 'šutevi u okvir gola 1+';
                        if (market.Line === 1.5) key = 'šutevi u okvir gola 2+';
                        if (market.Line === 2.5) key = 'šutevi u okvir gola 3+';
                    } else if (columnName) {
                        key = columnName;
                    }
                    if(key) markets[key] = market.Odds;
                });

                // Calculate 'Gol ili asistencija' if not present but its components are
                if (!markets['gol ili asistencija'] && markets['daje gol'] && markets['asistencija']) {
                    const oddsScore = parseFloat(markets['daje gol']);
                    const oddsAssist = parseFloat(markets['asistencija']);

                    if (!isNaN(oddsScore) && !isNaN(oddsAssist)) {
                        const probScore = 1 / oddsScore;
                        const probAssist = 1 / oddsAssist;
                        
                        // P(A or B) = 1 - P(not A) * P(not B)
                        const probScoreOrAssist = 1 - (1 - probScore) * (1 - probAssist);
                        
                        if (probScoreOrAssist > 0) {
                            const calculatedOdds = 1 / probScoreOrAssist;
                            
                            // Apply the same filter as for other odds
                            if (calculatedOdds >= 1.1 && calculatedOdds <= 40) {
                                 markets['gol ili asistencija'] = calculatedOdds.toFixed(2);
                                 logStatus(`Izračunata kvota 'Gol ili asistencija' za igrača ${playerInfo.name}: ${calculatedOdds.toFixed(2)}`);
                            }
                        }
                    }
                }
                 
                // Find "Score and Win" odds from prePacks
                if (fetchedMarketData && fetchedMarketData.prePacks) {
                    const searchLabelTeamWin = `Full Time ${playerInfo.teamName}`;
                    const searchLabelPlayerScore = `${playerInfo.name} To Score`;
                    
                    for (const pack of fetchedMarketData.prePacks) {
                        for (const selection of pack.prePackSelections) {
                            if (selection.label.length === 2 && 
                                selection.label.includes(searchLabelTeamWin) && 
                                selection.label.includes(searchLabelPlayerScore)) 
                            {
                                const scoreAndWinOdds = (selection.combinations[0].odds.decimal / 1000);
                                if (scoreAndWinOdds >= 1.1 && scoreAndWinOdds <= 40) {
                                    const marketKey = `daje gol i ${playerInfo.teamName} pobeđuje`;
                                    markets[marketKey] = scoreAndWinOdds.toFixed(2);
                                }
                                break; 
                            }
                        }
                    }
                }

                if (Object.keys(markets).length > 0) {
                    previewData.push({
                        teamName: playerInfo.teamName,
                        playerName: playerInfo.name, // Keep original name for display in preview
                        markets: markets
                    });
                }
            });

            if (previewData.length === 0) {
                logStatus("Nema dostupnih igara za izabrane igrače koje zadovoljavaju filter (kvota između 1.1 i 40). Proverite druge igrače.", true);
                csvPreviewSection.classList.add('hidden');
                return;
            }

            renderCsvPreview();
            csvPreviewSection.classList.remove('hidden');
        }

        function renderCsvPreview() {
            csvPreviewContent.innerHTML = '';
            previewData.forEach((playerData, playerIndex) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'mb-4 p-4 border rounded-lg';
                playerDiv.innerHTML = `
                    <p class="font-bold text-lg"><span class="font-normal text-gray-500">MATCH_NAME:</span> ${playerData.teamName}</p>
                    <p class="font-bold text-lg"><span class="font-normal text-gray-500">LEAGUE_NAME:</span> ${removeDiacritics(playerData.playerName)}</p>
                `;
                const table = document.createElement('table');
                table.className = 'mt-2 w-full text-sm';
                
                const tbody = document.createElement('tbody');
                
                const sortedMarketKeys = Object.keys(playerData.markets).sort((a, b) => {
                    // Handle dynamic "score and win" market
                    const isScoreWinA = a.includes('daje gol i');
                    const isScoreWinB = b.includes('daje gol i');
                    if (isScoreWinA && !isScoreWinB) return -1;
                    if (!isScoreWinA && isScoreWinB) return 1;

                    const indexA = marketSortOrder.indexOf(a);
                    const indexB = marketSortOrder.indexOf(b);
                    
                    if (indexA === -1) return 1; 
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });

                sortedMarketKeys.forEach(marketKey => {
                    const odd = playerData.markets[marketKey];
                    const tr = document.createElement('tr');
                    tr.className = 'border-t';
                    tr.innerHTML = `
                        <td class="py-2 pr-4 text-gray-600 w-1/3">${marketKey}</td>
                        <td class="py-2 w-1/3">
                            <input 
                                type="text" 
                                value="${odd}" 
                                class="w-24 p-1 border rounded-md"
                                data-player-index="${playerIndex}"
                                data-market-key="${marketKey}"
                            >
                        </td>
                        <td class="py-2 text-right w-1/3">
                            <button 
                                class="text-red-500 font-bold hover:text-red-700 text-lg"
                                data-player-index="${playerIndex}"
                                data-market-key="${marketKey}"
                            >&times;</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                table.appendChild(tbody);
                playerDiv.appendChild(table);
                csvPreviewContent.appendChild(playerDiv);
            });
        }
        
        csvPreviewContent.addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT') {
                const { playerIndex, marketKey } = e.target.dataset;
                previewData[playerIndex].markets[marketKey] = e.target.value;
            }
        });

        csvPreviewContent.addEventListener('click', (e) => {
             if (e.target.tagName === 'BUTTON') {
                const { playerIndex, marketKey } = e.target.dataset;
                delete previewData[playerIndex].markets[marketKey];
                renderCsvPreview(); // Re-render to show the change
            }
        });
        
        function generateFinalPlayerPropsCSV() {
             if (previewData.length === 0) {
                logStatus('No player data in preview to generate CSV.', true);
                return;
            }

            const header = "Datum,Vreme,Sifra,,Domacin,Gost,,1,X,2,GR,U,O,Yes,No";
            let csvRows = [header];

            const eventInfo = fetchedMarketData.events[0];
            const matchDate = new Date(eventInfo.start);
            const datum = `${matchDate.getDate().toString().padStart(2, '0')}.${(matchDate.getMonth() + 1).toString().padStart(2, '0')}.${matchDate.getFullYear()}`;
            const vreme = `${matchDate.getHours().toString().padStart(2, '0')}:${matchDate.getMinutes().toString().padStart(2, '0')}`;
            
            let isFirstPlayer = true;
            previewData.forEach(playerData => {
                if (isFirstPlayer) {
                    csvRows.push(`MATCH_NAME:${playerData.teamName}`);
                    isFirstPlayer = false;
                }
                csvRows.push(`LEAGUE_NAME:${removeDiacritics(playerData.playerName)}`);
                
                const sortedMarketKeys = Object.keys(playerData.markets).sort((a, b) => {
                     // Handle dynamic "score and win" market
                    const isScoreWinA = a.includes('daje gol i');
                    const isScoreWinB = b.includes('daje gol i');
                    if (isScoreWinA && !isScoreWinB) return -1;
                    if (!isScoreWinA && isScoreWinB) return 1;

                    const indexA = marketSortOrder.indexOf(a);
                    const indexB = marketSortOrder.indexOf(b);
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });

                sortedMarketKeys.forEach(marketKey => {
                    const odd = playerData.markets[marketKey];
                    let domacin = marketKey;
                    let gost = "DA";
                    
                    const parts = marketKey.split(' ');
                    const lastPart = parts[parts.length - 1];
                    const knownLines = ['1+', '2+', '3+', '4+'];
                    if (knownLines.includes(lastPart)) {
                        domacin = parts.slice(0, -1).join(' ');
                        gost = lastPart;
                    }
                    
                    const row = [datum, vreme, '', '', domacin, gost, '', odd, '', '', '', '', '', '', ''];
                    csvRows.push(row.join(','));
                });
            });

            const csvContent = csvRows.join('\n');
            const firstTeamName = previewData[0]?.teamName || "export";
            const fileName = `${firstTeamName.replace(/ /g, '_')}_odds.csv`;
            
            downloadCSV(csvContent, fileName);
            logStatus('Final Player Props Special CSV generated!');
        }

        function handleClearPlayers() {
            selectedPlayersForCSV = [];
            updateSelectedPlayersList();
            csvPreviewSection.classList.add('hidden');
            logStatus('Lista izabranih igrača je obrisana.');
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            populateLeagues();
            
            // Define all event listeners after DOM is loaded
            leagueSelect.addEventListener('change', (e) => fetchMatchesForLeague(e.target.value));
            matchSelect.addEventListener('change', () => {
                fetchMarketsButton.disabled = !matchSelect.value;
                openMatchSpecialsButton.disabled = !matchSelect.value;
                resetTables();
                mainTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Click "Fetch Markets" to see data.</td></tr>';
                downloadContainer.classList.add('hidden');
                playerCsvGeneratorSection.classList.add('hidden');
            });
            fetchMarketsButton.addEventListener('click', fetchAndDisplayMarkets);
            downloadCsvButton.addEventListener('click', handleAllMarketsDownload);
            toggleRawDataButton.addEventListener('click', () => {
                rawDataContainer.classList.toggle('hidden');
            });
            tabs.forEach(tab => tab.addEventListener('click', handleTabClick));

            teamSelect.addEventListener('change', (e) => populatePlayersForTeam(e.target.value));
            playerSelect.addEventListener('change', () => {
                addPlayerButton.disabled = !playerSelect.value;
            });
            addPlayerButton.addEventListener('click', handleAddPlayer);
            previewPlayerCsvButton.addEventListener('click', showCsvPreview);
            generateFinalCsvButton.addEventListener('click', generateFinalPlayerPropsCSV);
            clearPlayersButton.addEventListener('click', handleClearPlayers);

             openMatchSpecialsButton.addEventListener('click', () => {
                const eventId = matchSelect.value;
                if(eventId) {
                    // Save data to sessionStorage to pass to the next page
                    sessionStorage.setItem(`event_${eventId}`, JSON.stringify(fetchedMarketData));
                    window.open(`match-specials.html?eventId=${eventId}`, '_blank');
                }
            });
        });

    </script>
</body>
</html>

