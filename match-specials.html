<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xtip Specijali</title>
    <link rel="icon" type="image/png" href="merkur.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Meč Specijal Generator</h1>
            <p id="matchNameHeader" class="text-gray-600 mt-2">Loading match details...</p>
        </header>

        <main class="bg-white rounded-lg shadow-md p-6">
            <div id="loader" class="flex justify-center items-center h-48">
                <div class="spinner"></div>
            </div>

            <div id="specialsContent" class="hidden">
                <div id="specialsList" class="space-y-3">
                    <!-- Calculated specials will be inserted here -->
                </div>
                
                 <div class="mt-8 pt-6 border-t border-gray-200">
                    <h2 class="text-2xl font-bold text-indigo-800 mb-4">Pregled Specijala za CSV</h2>
                     <div id="csvPreviewContent" class="space-y-6">
                         <!-- Preview content will be generated here -->
                     </div>
                     <div class="mt-6 text-right">
                         <button id="generateCsvButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                             Generiši CSV za Meč Specijal
                         </button>
                     </div>
                </div>
            </div>
             <div id="errorContainer" class="hidden text-center text-red-500 p-4 bg-red-50 rounded-lg">
                <!-- Error messages will be shown here -->
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loader = document.getElementById('loader');
            const specialsContent = document.getElementById('specialsContent');
            const errorContainer = document.getElementById('errorContainer');
            const matchNameHeader = document.getElementById('matchNameHeader');
            const specialsList = document.getElementById('specialsList');
            const csvPreviewContent = document.getElementById('csvPreviewContent');
            const generateCsvButton = document.getElementById('generateCsvButton');
            
            let allMarkets = [];
            let fetchedData = null;
            let specialsForPreview = [];

            function removeDiacritics(text) {
                 if (!text) return '';
                text = text.replace(/đ/g, 'dj').replace(/Đ/g, 'Dj');
                return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }

            function logError(message) {
                loader.style.display = 'none';
                errorContainer.textContent = message;
                errorContainer.classList.remove('hidden');
            }

            // 1. Get Event ID and Fetch Data
            const params = new URLSearchParams(window.location.search);
            const eventId = params.get('eventId');

            if (!eventId) {
                logError("Event ID nije pronađen. Molimo vas vratite se na prethodnu stranicu i izaberite meč.");
                return;
            }
            
            const storedData = sessionStorage.getItem(`event_${eventId}`);
            if (storedData) {
                fetchedData = JSON.parse(storedData);
            } else {
                 logError("Podaci o meču nisu pronađeni. Molimo vas da prvo učitate meč na glavnoj stranici.");
                return;
            }

            try {
                const eventName = fetchedData.events[0]?.name || "Nepoznat meč";
                matchNameHeader.textContent = `Specijali za meč: ${eventName}`;
                
                // Flatten all outcomes into a simple array for easier lookup
                fetchedData.betOffers.forEach(offer => {
                    offer.outcomes.forEach(outcome => {
                        allMarkets.push({
                            betOfferId: offer.id,
                            marketName: offer.criterion.label,
                            line: (outcome.line !== undefined && outcome.line !== null) ? (outcome.line / 1000) : null,
                            label: outcome.label,
                            odds: (outcome.odds / 1000)
                        });
                    });
                });
                
                calculateAndDisplaySpecials();

            } catch (error) {
                logError(`Greška pri obradi podataka: ${error.message}`);
                return;
            }

            // 2. Helper function to find a specific odd
             function getOdd(marketNameIdentifier, line, labelIdentifier) {
                const marketNameLower = marketNameIdentifier.toLowerCase();
                const labelLower = labelIdentifier.toLowerCase();
                
                // Prioritize exact matches for "Total..." markets to avoid half-time/team versions
                if (marketNameLower.startsWith("total")) {
                    const exactMatch = allMarkets.find(m => 
                        m.marketName.toLowerCase() === marketNameLower &&
                        m.line === line &&
                        m.label.toLowerCase() === labelLower
                    );
                    if (exactMatch) return exactMatch.odds;
                }

                // Fallback to looser search but exclude half-time and team specific
                const market = allMarkets.find(m => 
                    m.marketName.toLowerCase().includes(marketNameLower) &&
                    !m.marketName.toLowerCase().includes('1st half') &&
                    !m.marketName.toLowerCase().includes('2nd half') &&
                    !m.marketName.toLowerCase().includes('by team') &&
                    !m.marketName.toLowerCase().includes(`by ${fetchedData.events[0].participants[0].name.toLowerCase()}`) &&
                     !m.marketName.toLowerCase().includes(`by ${fetchedData.events[0].participants[1].name.toLowerCase()}`) &&
                    m.line === line &&
                    m.label.toLowerCase().includes(labelLower)
                );
                return market ? market.odds : null;
            }

            // 3. Newton-Raphson method to find lambda (expected goals)
            function lambda_from_p_over(p_over, tol = 1e-8, maxiter = 50) {
                let lam = 2.0; // Initial guess
                for (let i = 0; i < maxiter; i++) {
                    const exp_neg_lam = Math.exp(-lam);
                    const f = 1 - exp_neg_lam * (1 + lam + (lam * lam) / 2) - p_over;
                    const fp = exp_neg_lam * ((lam * lam) / 2);
                    if (Math.abs(fp) < 1e-12) {
                        break;
                    }
                    const step = f / fp;
                    lam -= step;
                    if (Math.abs(step) < tol) {
                        break;
                    }
                }
                return lam;
            }
            
            // 4. Define and Calculate Specials
            function calculateAndDisplaySpecials() {
                const q_over_2_5 = getOdd("Total Goals", 2.5, "over");
                const q_under_2_5 = getOdd("Total Goals", 2.5, "under");
                let lam = 2.7; // Default fallback lambda (expected goals)

                if (q_over_2_5 && q_under_2_5) {
                    const p_over_raw = 1.0 / q_over_2_5;
                    const p_under_raw = 1.0 / q_under_2_5;
                    const margin = p_over_raw + p_under_raw;
                    const p_over = p_over_raw / margin; // Normalize to remove margin
                    lam = lambda_from_p_over(p_over);
                }

                 const specialsToCalculate = [
                    { name: "10+ kornera i GG", components: [() => getOdd("Total Corners", 9.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "10+ suteva u okvir i 3+ golova", components: [() => getOdd("Total Shots on Target (Settled using Opta data)", 9.5, "over"), () => getOdd("Total Goals", 2.5, "over")] },
                    { name: "11+ suteva u okvir i GG", components: [() => getOdd("Total Shots on Target (Settled using Opta data)", 10.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "15+ kornera i 3+ golova", components: [() => getOdd("Total Corners", 14.5, "over"), () => getOdd("Total Goals", 2.5, "over")] },
                    { name: "15+ kornera i GG", components: [() => getOdd("Total Corners", 14.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "10+ kornera i 3+ golova", components: [() => getOdd("Total Corners", 9.5, "over"), () => getOdd("Total Goals", 2.5, "over")] },
                    { name: "9+ kornera i 3+ golova i 4+ kartona", components: [() => getOdd("Total Corners", 8.5, "over"), () => getOdd("Total Goals", 2.5, "over"), () => getOdd("Total Cards", 3.5, "over")] },
                    { name: "3+ golova i 4+ kartona", components: [() => getOdd("Total Goals", 2.5, "over"), () => getOdd("Total Cards", 3.5, "over")] },
                    { name: "3+ golova i 8+ kornera", components: [() => getOdd("Total Goals", 2.5, "over"), () => getOdd("Total Corners", 7.5, "over")] },
                    { name: "9+ suteva u okvir i GG", components: [() => getOdd("Total Shots on Target (Settled using Opta data)", 8.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "12+ kornera i GG", components: [() => getOdd("Total Corners", 11.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "9+ kornera i 3+ kartona i GG", components: [() => getOdd("Total Corners", 8.5, "over"), () => getOdd("Total Cards", 2.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "9+ kornera i 4+ kartona i GG", components: [() => getOdd("Total Corners", 8.5, "over"), () => getOdd("Total Cards", 3.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "8+ kornera i GG", components: [() => getOdd("Total Corners", 7.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "Penal i crveni karton", components: [() => getOdd("Penalty Kick awarded", null, "yes"), () => getOdd("Red Card given", null, "yes")], multiplier: 0.8 },
                    { name: "Penal ili crveni karton", calculation: () => {
                        const oddsPen = getOdd("Penalty Kick awarded", null, "yes");
                        const oddsRed = getOdd("Red Card given", null, "yes");
                        if (!oddsPen || !oddsRed) return null;
                        const pPen = 1 / oddsPen;
                        const pRed = 1 / oddsRed;
                        const pPenAndRed = 1 / (oddsPen * oddsRed * 0.8);
                        const pOr = pPen + pRed - pPenAndRed;
                        return 1 / pOr;
                    }},
                    { name: "Izmena postize gol", calculation: () => {
                        const lambda_sub = lam * 0.15;
                        const prob = 1 - Math.exp(-lambda_sub);
                        return prob > 0 ? 1 / prob : null;
                    }},
                    { name: "Gol glavom na mecu", calculation: () => {
                        const lambda_header = lam * 0.17;
                        const prob = 1 - Math.exp(-lambda_header);
                        return prob > 0 ? 1 / prob : null;
                    }},
                    { name: "Gol izvan 16m", calculation: () => {
                        const lambda_outside = lam * 0.12;
                        const prob = 1 - Math.exp(-lambda_outside);
                        return prob > 0 ? 1 / prob : null;
                    }},
                    { name: "Gol iz slobodnog udarca", calculation: () => {
                        const lambda_fk = lam * 0.05;
                        const prob = 1 - Math.exp(-lambda_fk);
                        return prob > 0 ? 1 / prob : null;
                    }},
                ];
                
                specialsList.innerHTML = '';
                specialsToCalculate.forEach(special => {
                    let finalOdd = null;
                    if (special.components) {
                        const odds = special.components.map(fn => fn());
                        if (odds.every(o => o !== null)) {
                            finalOdd = odds.reduce((acc, val) => acc * val, 1) * (special.multiplier || 1);
                        }
                    } else if (special.calculation) {
                        finalOdd = special.calculation();
                    }

                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 border rounded-lg';
                    div.innerHTML = `
                        <span class="text-gray-800">${special.name}</span>
                        ${finalOdd !== null && !isNaN(finalOdd) ? `
                        <div class="flex items-center">
                            <span class="font-bold text-lg mr-4">${finalOdd.toFixed(2)}</span>
                            <button data-name="${special.name}" data-odds="${finalOdd.toFixed(2)}" class="add-special-btn bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">+</button>
                        </div>
                        ` : '<span class="text-sm text-gray-400">Nije dostupno</span>'}
                    `;
                    specialsList.appendChild(div);
                });
                
                loader.style.display = 'none';
                specialsContent.classList.remove('hidden');
            }

            function renderPreview() {
                if (specialsForPreview.length > 0) {
                    csvPreviewContent.parentElement.classList.remove('hidden');
                } else {
                    csvPreviewContent.parentElement.classList.add('hidden');
                }

                csvPreviewContent.innerHTML = '';
                specialsForPreview.forEach((special, index) => {
                     const div = document.createElement('div');
                     div.className = 'flex justify-between items-center p-2 border-b';
                     div.innerHTML = `
                        <span>${special.name}</span>
                        <div class="flex items-center">
                            <input type="text" value="${special.odds}" class="w-20 p-1 border rounded" data-index="${index}">
                            <button class="remove-special-btn ml-4 text-red-500 font-bold" data-index="${index}">&times;</button>
                        </div>
                     `;
                     csvPreviewContent.appendChild(div);
                });
            }

            // Event Listeners
            specialsList.addEventListener('click', e => {
                if (e.target.classList.contains('add-special-btn')) {
                    const { name, odds } = e.target.dataset;
                    if (!specialsForPreview.some(s => s.name === name)) {
                        specialsForPreview.push({ name, odds });
                        renderPreview();
                    }
                }
            });

            csvPreviewContent.addEventListener('click', e => {
                if (e.target.classList.contains('remove-special-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    specialsForPreview.splice(index, 1);
                    renderPreview();
                }
            });
            
             csvPreviewContent.addEventListener('input', e => {
                if (e.target.tagName === 'INPUT') {
                    const index = parseInt(e.target.dataset.index, 10);
                    specialsForPreview[index].odds = e.target.value;
                }
            });
            
            generateCsvButton.addEventListener('click', () => {
                 if (specialsForPreview.length === 0) return;

                const header = "Datum,Vreme,Sifra,,Domacin,Gost,,1,X,2,GR,U,O,Yes,No";
                let csvRows = [header];

                const eventInfo = fetchedData.events[0];
                const matchDate = new Date(eventInfo.start);
                const datum = `${matchDate.getDate().toString().padStart(2, '0')}.${(matchDate.getMonth() + 1).toString().padStart(2, '0')}.${matchDate.getFullYear()}`;
                const vreme = `${matchDate.getHours().toString().padStart(2, '0')}:${matchDate.getMinutes().toString().padStart(2, '0')}`;
                
                csvRows.push('MATCH_NAME:Xtip Specijal');
                csvRows.push(`LEAGUE_NAME:${eventInfo.name}`);
                
                specialsForPreview.forEach(special => {
                    const row = [datum, vreme, '', '', special.name, 'DA', '', special.odds, '', '', '', '', '', '', ''];
                    csvRows.push(row.join(','));
                });

                const csvContent = csvRows.join('\n');
                const matchName = removeDiacritics(eventInfo.name).replace(/ /g, '_').replace(/vs/, '');
                const fileName = `mec_specijal_${matchName}.csv`;
                
                const BOM = "\uFEFF";
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

        });
    </script>
</body>
</html>

