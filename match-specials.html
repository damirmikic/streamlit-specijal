<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xtip Specijal</title>
    <link rel="icon" type="image/png" href="merkur.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Meč Specijal Generator</h1>
            <p id="matchNameHeader" class="text-gray-600 mt-2">Loading match details...</p>
        </header>

        <main class="bg-white rounded-lg shadow-md p-6">
            <div id="loader" class="flex justify-center items-center h-48">
                <div class="spinner"></div>
            </div>

            <div id="specialsContent" class="hidden">
                <div id="specialsList" class="space-y-3">
                    </div>
                
                 <div class="mt-8 pt-6 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-indigo-800">Pregled Specijala za CSV</h2>
                        <button id="addAllSpecialsButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                            Dodaj sve markete u CSV
                        </button>
                    </div>
                     <div id="csvPreviewContent" class="space-y-6">
                         </div>
                     <div class="mt-6 text-right">
                         <button id="generateCsvButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                             Generiši CSV za Meč Specijal
                         </button>
                     </div>
                </div>
            </div>
             <div id="errorContainer" class="hidden text-center text-red-500 p-4 bg-red-50 rounded-lg">
                </div>
        </main>
    </div>
    
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loader = document.getElementById('loader');
            const specialsContent = document.getElementById('specialsContent');
            const errorContainer = document.getElementById('errorContainer');
            const matchNameHeader = document.getElementById('matchNameHeader');
            const specialsList = document.getElementById('specialsList');
            const csvPreviewContent = document.getElementById('csvPreviewContent');
            const generateCsvButton = document.getElementById('generateCsvButton');
            const addAllSpecialsButton = document.getElementById('addAllSpecialsButton');
            
            let allMarkets = [];
            let fetchedData = null;
            let specialsForPreview = [];

            function removeDiacritics(text) {
                 if (!text) return '';
                text = text.replace(/đ/g, 'dj').replace(/Đ/g, 'Dj');
                return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }

            function roundOdds(oddsStr) {
                const odd = parseFloat(oddsStr);
                if (odd > 5) {
                    return (Math.round(odd / 0.1) * 0.1).toFixed(2);
                } else if (odd > 3.5) {
                    return (Math.round(odd / 0.05) * 0.05).toFixed(2);
                }
                return oddsStr;
            }
            
            function translatePrepackLabel(label) {
                let originalLabel = label;
                
                // Prvo, opštiji prevodi koji sadrže druge
                label = label.replace(/Player's shots on target \(Settled using Opta data\)/gi, "Šutevi u okvir gola");
                label = label.replace(/Player's shots \(Settled using Opta data\)/gi, "Ukupno šuteva");
                label = label.replace(/Player's fouls conceded \(Settled using Opta data\)/gi, "Načinjenih faulova");
                label = label.replace(/To Score Or Assist \(Settled using Opta data\)/gi, "Gol ili asistencija");
                label = label.replace(/To score or get an assist/gi, "Gol ili asistencija");
                label = label.replace(/To Score or Assist/gi, "Gol ili asistencija");
                label = label.replace(/To Assist \(Settled using Opta data\)/gi, "Asistencija");
                label = label.replace(/To score at least 2 goals/gi, "Daje 2+ gola");
                label = label.replace(/To score at least 3 goals/gi, "Daje 3+ gola (Het-trik)");
                label = label.replace(/To score from a header/gi, "Daje gol glavom");
                label = label.replace(/To score from outside the penalty box/gi, "Daje gol izvan šesnaesterca");

                // Specifični prevodi
                label = label.replace(/Yes Both Teams To Score/gi, "GG");
                label = label.replace(/No Both Teams To Score/gi, "NG");
                label = label.replace(/Both Teams To Score/gi, "GG"); // Fallback
                label = label.replace(/Total Corners/gi, "ukupno kornera");
                label = label.replace(/Total Cards/gi, "ukupno kartona");
                label = label.replace(/Total Goals/gi, "ukupno golova");
                label = label.replace(/Most Corners/gi, "više kornera");
                label = label.replace(/Most Cards/gi, "više kartona");

                // Zatim specifični, kraći
                label = label.replace(/To Score/gi, "Daje gol");
                label = label.replace(/To Get a Card/gi, "Dobija karton");
                label = label.replace(/To Get a Red Card/gi, "Dobija crveni karton");
                
                // Ishodi
                label = label.replace(/Over/gi, "više");
                label = label.replace(/Under/gi, "manje");
                
                // Timovi
                label = label.replace(/Full Time (.+)/gi, "$1 pobeđuje");

                // Ako nijedan prevod nije primenjen, vrati original (malo verovatno)
                return label.trim() === originalLabel.trim() ? label : label.trim();
            }


            function logError(message) {
                loader.style.display = 'none';
                errorContainer.textContent = message;
                errorContainer.classList.remove('hidden');
            }

            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                let bgColor = 'bg-green-500';
                if (type === 'error') bgColor = 'bg-red-500';
                if (type === 'info') bgColor = 'bg-blue-500';
                
                toast.className = `${bgColor} text-white text-sm font-bold px-4 py-3 rounded-lg shadow-md animate-pulse`;
                toast.textContent = message;
                
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2500);
            }

            // 1. Get Event ID and Fetch Data
            const params = new URLSearchParams(window.location.search);
            const eventId = params.get('eventId');

            if (!eventId) {
                logError("Event ID nije pronađen. Molimo vas vratite se na prethodnu stranicu i izaberite meč.");
                return;
            }
            
            const storedData = sessionStorage.getItem(`event_${eventId}`);
            if (storedData) {
                fetchedData = JSON.parse(storedData);
            } else {
                 logError("Podaci o meču nisu pronađeni. Molimo vas da prvo učitate meč na glavnoj stranici.");
                return;
            }

            try {
                const eventName = fetchedData.events[0]?.name || "Nepoznat meč";
                matchNameHeader.textContent = `Specijali za meč: ${eventName}`;
                
                // Flatten all outcomes into a simple array for easier lookup
                fetchedData.betOffers.forEach(offer => {
                    offer.outcomes.forEach(outcome => {
                        allMarkets.push({
                            betOfferId: offer.id,
                            marketName: offer.criterion.label,
                            line: (outcome.line !== undefined && outcome.line !== null) ? (outcome.line / 1000) : null,
                            label: outcome.label,
                            odds: (outcome.odds / 1000)
                        });
                    });
                });
                
                calculateAndDisplaySpecials();

            } catch (error) {
                logError(`Greška pri obradi podataka: ${error.message}`);
                return;
            }

            // 2. Helper function to find a specific odd
             function getOdd(marketNameIdentifier, line, labelIdentifier) {
                const marketNameLower = marketNameIdentifier.toLowerCase();
                const labelLower = labelIdentifier.toLowerCase();
                
                // Mape za prevod na osnovu korisničkih zahteva
                const marketTranslations = {
                    "total goals": "ukupno golova",
                    "total corners": "ukupno kornera",
                    "total cards": "ukupno kartona",
                    "both teams to score": "gg",
                    "penalty kick awarded": "penalty kick awarded",
                    "red card given": "red card given",
                    "total shots on target (settled using opta data)": "total shots on target (settled using opta data)"
                };
                
                const labelTranslations = {
                    "over": "više",
                    "under": "manje",
                    "yes": "yes",
                    "no": "no"
                };

                const translatedMarket = marketTranslations[marketNameLower] || marketNameLower;
                const translatedLabel = labelTranslations[labelLower] || labelLower;

                const exactMatch = allMarkets.find(m => 
                    m.marketName.toLowerCase() === translatedMarket &&
                    m.line === line &&
                    m.label.toLowerCase() === translatedLabel
                );
                if (exactMatch) return exactMatch.odds;
                
                // Fallback za sirove engleske nazive
                const rawMatch = allMarkets.find(m => 
                    m.marketName.toLowerCase() === marketNameLower &&
                    m.line === line &&
                    m.label.toLowerCase() === labelLower
                );
                if (rawMatch) return rawMatch.odds;


                const looserMatch = allMarkets.find(m => 
                    (m.marketName.toLowerCase().includes(translatedMarket) || m.marketName.toLowerCase().includes(marketNameLower)) &&
                    !m.marketName.toLowerCase().includes('1st half') &&
                    !m.marketName.toLowerCase().includes('2nd half') &&
                    !m.marketName.toLowerCase().includes('by team') &&
                    !m.marketName.toLowerCase().includes(`by ${fetchedData.events[0].participants[0].name.toLowerCase()}`) &&
                    !m.marketName.toLowerCase().includes(`by ${fetchedData.events[0].participants[1].name.toLowerCase()}`) &&
                    m.line === line &&
                    (m.label.toLowerCase() === translatedLabel || m.label.toLowerCase() === labelLower)
                );

                return looserMatch ? looserMatch.odds : null;
            }

            // 3. Newton-Raphson method to find lambda (expected goals)
            function lambda_from_p_over(p_over, tol = 1e-8, maxiter = 50) {
                let lam = 2.0; // Initial guess
                for (let i = 0; i < maxiter; i++) {
                    const exp_neg_lam = Math.exp(-lam);
                    const f = 1 - exp_neg_lam * (1 + lam + (lam * lam) / 2) - p_over;
                    const fp = exp_neg_lam * ((lam * lam) / 2);
                    if (Math.abs(fp) < 1e-12) {
                        break;
                    }
                    const step = f / fp;
                    lam -= step;
                    if (Math.abs(step) < tol) {
                        break;
                    }
                }
                return lam;
            }
            
            // 4. Define and Calculate Specials
            function calculateAndDisplaySpecials() {
                const q_over_2_5 = getOdd("Total Goals", 2.5, "over");
                const q_under_2_5 = getOdd("Total Goals", 2.5, "under");
                let lam = 2.7; // Default fallback lambda (expected goals)

                if (q_over_2_5 && q_under_2_5) {
                    const p_over_raw = 1.0 / q_over_2_5;
                    const p_under_raw = 1.0 / q_under_2_5;
                    const margin = p_over_raw + p_under_raw;
                    const p_over = p_over_raw / margin; // Normalize to remove margin
                    lam = lambda_from_p_over(p_over);
                }

                 const specialsToCalculate = [
                    { name: "10+ kornera i GG", components: [() => getOdd("Total Corners", 9.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "10+ suteva u okvir i 3+ golova", components: [() => getOdd("Total Shots on Target (Settled using Opta data)", 9.5, "over"), () => getOdd("Total Goals", 2.5, "over")] },
                    { name: "11+ suteva u okvir i GG", components: [() => getOdd("Total Shots on Target (Settled using Opta data)", 10.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "15+ kornera i 3+ golova", components: [() => getOdd("Total Corners", 14.5, "over"), () => getOdd("Total Goals", 2.5, "over")] },
                    { name: "15+ kornera i GG", components: [() => getOdd("Total Corners", 14.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "10+ kornera i 3+ golova", components: [() => getOdd("Total Corners", 9.5, "over"), () => getOdd("Total Goals", 2.5, "over")] },
                    { name: "9+ kornera i 3+ golova i 4+ kartona", components: [() => getOdd("Total Corners", 8.5, "over"), () => getOdd("Total Goals", 2.5, "over"), () => getOdd("Total Cards", 3.5, "over")] },
                    { name: "3+ golova i 4+ kartona", components: [() => getOdd("Total Goals", 2.5, "over"), () => getOdd("Total Cards", 3.5, "over")] },
                    { name: "3+ golova i 8+ kornera", components: [() => getOdd("Total Goals", 2.5, "over"), () => getOdd("Total Corners", 7.5, "over")] },
                    { name: "9+ suteva u okvir i GG", components: [() => getOdd("Total Shots on Target (Settled using Opta data)", 8.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "12+ kornera i GG", components: [() => getOdd("Total Corners", 11.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "9+ kornera i 3+ kartona i GG", components: [() => getOdd("Total Corners", 8.5, "over"), () => getOdd("Total Cards", 2.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "9+ kornera i 4+ kartona i GG", components: [() => getOdd("Total Corners", 8.5, "over"), () => getOdd("Total Cards", 3.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "8+ kornera i GG", components: [() => getOdd("Total Corners", 7.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { name: "Penal i crveni karton", components: [() => getOdd("Penalty Kick awarded", null, "yes"), () => getOdd("Red Card given", null, "yes")], multiplier: 0.8 },
                    { name: "Penal ili crveni karton", calculation: () => {
                        const oddsPen = getOdd("Penalty Kick awarded", null, "yes");
                        const oddsRed = getOdd("Red Card given", null, "yes");
                        if (!oddsPen || !oddsRed) return null;
                        const pPen = 1 / oddsPen;
                        const pRed = 1 / oddsRed;
                        const pPenAndRed = 1 / (oddsPen * oddsRed * 0.8);
                        const pOr = pPen + pRed - pPenAndRed;
                        return 1 / pOr;
                    }},
                    { name: "Izmena postize gol", calculation: () => {
                        const lambda_sub = lam * 0.15;
                        const prob = 1 - Math.exp(-lambda_sub);
                        return prob > 0 ? 1 / prob : null;
                    }},
                    { name: "Gol glavom na mecu", calculation: () => {
                        const lambda_header = lam * 0.17;
                        const prob = 1 - Math.exp(-lambda_header);
                        return prob > 0 ? 1 / prob : null;
                    }},
                    { name: "Gol izvan 16m", calculation: () => {
                        const lambda_outside = lam * 0.12;
                        const prob = 1 - Math.exp(-lambda_outside);
                        return prob > 0 ? 1 / prob : null;
                    }},
                    { name: "Gol iz slobodnog udarca", calculation: () => {
                        const lambda_fk = lam * 0.05;
                        const prob = 1 - Math.exp(-lambda_fk);
                        return prob > 0 ? 1 / prob : null;
                    }},
                ];
                
                specialsList.innerHTML = '';
                
                // Prvo, prikaži izračunate specijale
                specialsToCalculate.forEach(special => {
                    let finalOdd = null;
                    if (special.components) {
                        const odds = special.components.map(fn => fn());
                        if (odds.every(o => o !== null)) {
                            finalOdd = odds.reduce((acc, val) => acc * val, 1) * (special.multiplier || 1);
                        }
                    } else if (special.calculation) {
                        finalOdd = special.calculation();
                    }

                    if (finalOdd) finalOdd = parseFloat(roundOdds(String(finalOdd)));

                    const oddValue = (finalOdd !== null && !isNaN(finalOdd)) ? finalOdd.toFixed(2) : '';
                    const inputId = `odds-input-${special.name.replace(/[^a-zA-Z0-9]/g, '-')}`;

                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 border rounded-lg';
                    div.innerHTML = `
                        <span class="text-gray-800 flex-1">${special.name}</span>
                        <div class="flex items-center gap-3 w-auto md:w-1/3">
                            <input 
                                type="text" 
                                value="${oddValue}" 
                                class="odds-input w-24 p-1 border rounded text-center font-medium" 
                                placeholder="Unesi kvotu"
                                id="${inputId}"
                            >
                            <button 
                                data-name="${special.name}" 
                                data-input-id="${inputId}" 
                                class="add-special-btn bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600"
                            >+</button>
                        </div>
                    `;
                    specialsList.appendChild(div);
                });
                
                // NOVO: Dodaj PrePacks
                if (fetchedData.prePacks && fetchedData.prePacks.length > 0) {
                    
                    const separator = document.createElement('div');
                    separator.className = 'pt-4 mt-4 border-t border-gray-200';
                    separator.innerHTML = '<h3 class="text-lg font-semibold text-gray-700 mb-2">Pre-Pack Specijali (Direktno iz API-ja)</h3>';
                    specialsList.appendChild(separator);

                    fetchedData.prePacks.forEach(pack => {
                        pack.prePackSelections.forEach((selection, index) => {
                            const odds = (selection.combinations[0].odds.decimal / 1000);
                            if (odds < 1.1 || odds > 40) return; // Preskoči kvote van opsega

                            const translatedLabels = selection.label.map(translatePrepackLabel);
                            const marketName = translatedLabels.join(' I ');
                            const finalOdd = parseFloat(roundOdds(String(odds)));
                            
                            const oddValue = (finalOdd !== null && !isNaN(finalOdd)) ? finalOdd.toFixed(2) : '';
                            const inputId = `odds-input-prepack-${selection.selectionId || index}`; // Jedinstven ID

                            const div = document.createElement('div');
                            div.className = 'flex justify-between items-center p-3 border rounded-lg bg-indigo-50'; // Drugačija pozadina
                            div.innerHTML = `
                                <span class="text-gray-800 flex-1 text-sm">${marketName}</span>
                                <div class="flex items-center gap-3 w-auto md:w-1/3">
                                    <input 
                                        type="text" 
                                        value="${oddValue}" 
                                        class="odds-input w-24 p-1 border rounded text-center font-medium" 
                                        placeholder="Unesi kvotu"
                                        id="${inputId}"
                                    >
                                    <button 
                                        data-name="${marketName}" 
                                        data-input-id="${inputId}" 
                                        class="add-special-btn bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600"
                                    >+</button>
                                </div>
                            `;
                            specialsList.appendChild(div);
                        });
                    });
                }
                
                loader.style.display = 'none';
                specialsContent.classList.remove('hidden');
            }

            function renderPreview() {
                if (specialsForPreview.length > 0) {
                    csvPreviewContent.parentElement.classList.remove('hidden');
                } else {
                    csvPreviewContent.parentElement.classList.add('hidden');
                }

                csvPreviewContent.innerHTML = '';
                specialsForPreview.forEach((special, index) => {
                     const div = document.createElement('div');
                     div.className = 'grid grid-cols-[1fr,auto,auto] gap-4 items-center p-2 border-b';
                     div.innerHTML = `
                        <input 
                            type="text" 
                            value="${special.name}" 
                            class="w-full p-1 border rounded" 
                            data-index="${index}"
                            data-field="name"
                        >
                        <input 
                            type="text" 
                            value="${special.odds}" 
                            class="w-20 p-1 border rounded text-center" 
                            data-index="${index}"
                            data-field="odds"
                        >
                        <button 
                            class="remove-special-btn ml-4 text-red-500 font-bold" 
                            data-index="${index}"
                        >&times;</button>
                     `;
                     csvPreviewContent.appendChild(div);
                });
            }

            // Event Listeners
            specialsList.addEventListener('click', e => {
                if (e.target.classList.contains('add-special-btn')) {
                    const { name, inputId } = e.target.dataset;
                    const oddsInput = document.getElementById(inputId);
                    const odds = oddsInput.value;

                    if (!odds || isNaN(parseFloat(odds))) {
                        showToast("Molimo unesite ispravnu kvotu.", "error");
                        return;
                    }

                    if (!specialsForPreview.some(s => s.name === name)) {
                        specialsForPreview.push({ name, odds });
                        renderPreview();
                        showToast("Market dodat u CSV");
                    } else {
                        showToast("Market je već dodat u listu.", "info");
                    }
                }
            });
            
            addAllSpecialsButton.addEventListener('click', () => {
                let addedCount = 0;
                const allSpecialElements = specialsList.querySelectorAll('.add-special-btn');
                allSpecialElements.forEach(btn => {
                    const { name, inputId } = btn.dataset;
                    const oddsInput = document.getElementById(inputId);
                    const odds = oddsInput.value;

                    if (odds && !isNaN(parseFloat(odds)) && !specialsForPreview.some(s => s.name === name)) {
                        specialsForPreview.push({ name, odds });
                        addedCount++;
                    }
                });

                if (addedCount > 0) {
                    renderPreview();
                    showToast(`${addedCount} marketa dodato u CSV.`);
                } else {
                    showToast("Nema novih marketa za dodavanje.", "info");
                }
            });

            csvPreviewContent.addEventListener('click', e => {
                if (e.target.classList.contains('remove-special-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    specialsForPreview.splice(index, 1);
                    renderPreview();
                }
            });
            
             csvPreviewContent.addEventListener('input', e => {
                if (e.target.tagName === 'INPUT') {
                    const index = parseInt(e.target.dataset.index, 10);
                    const field = e.target.dataset.field; // "name" or "odds"
                    specialsForPreview[index][field] = e.target.value;
                }
            });
            
            generateCsvButton.addEventListener('click', () => {
                 if (specialsForPreview.length === 0) return;

                const header = "Datum,Vreme,Sifra,Domacin,Gost,1,X,2,GR,U,O,Yes,No";
                let csvRows = [header];

                const eventInfo = fetchedData.events[0];
                const matchDate = new Date(eventInfo.start);
                const datum = `${matchDate.getDate().toString().padStart(2, '0')}.${(matchDate.getMonth() + 1).toString().padStart(2, '0')}.${matchDate.getFullYear()}`;
                const vreme = `${matchDate.getHours().toString().padStart(2, '0')}:${matchDate.getMinutes().toString().padStart(2, '0')}`;
                
                csvRows.push('MATCH_NAME:Xtip Specijal');
                csvRows.push(`LEAGUE_NAME:${eventInfo.name}`);
                
                specialsForPreview.forEach(special => {
                    // Koristi ažurirani 'special.name' i 'special.odds' iz niza
                    const row = [datum, vreme, '', special.name, 'DA', special.odds, '', '', '', '', '', '', ''];
                    csvRows.push(row.join(','));
                });

                const csvContent = csvRows.join('\n');
                const matchName = removeDiacritics(eventInfo.name).replace(/ /g, '_').replace(/vs/, '');
                const fileName = `mec_specijal_${matchName}.csv`;
                
                const BOM = "\uFEFF";
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

        });
    </script>
</body>
</html>
