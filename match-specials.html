<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xtip Specijal</title>
    <link rel="icon" type="image/png" href="merkur.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        /* Style adjustments for better readability */
        input[type="text"]:disabled {
            background-color: #f3f4f6; /* Lighter gray for disabled inputs */
            cursor: not-allowed;
            opacity: 0.7;
        }
         button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
         }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Meč Specijal Generator</h1>
            <p id="matchNameHeader" class="text-gray-600 mt-2">Učitavanje detalja meča...</p>
        </header>

        <main class="bg-white rounded-lg shadow-md p-6">
            <div id="loader" class="flex justify-center items-center h-48">
                <div class="spinner"></div>
            </div>

            <div id="specialsContent" class="hidden">
                <!-- Lista generisanih i PrePack specijala -->
                 <div id="specialsList">
                   
                    <div id="calculatedSpecialsContainer" class="space-y-3"></div>
                   
                    <div id="calculatedButtonContainer" class="mt-4"></div>

                    
                    <div id="prepackSpecialsContainer" class="mt-6 space-y-3"></div>
                    <div id="prepackButtonContainer" class="mt-4"></div>
                 </div>


                 <!-- Sekcija za pregled i generisanje CSV-a -->
                 <div id="csvPreviewSectionContainer" class="mt-8 pt-6 border-t border-gray-200 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-indigo-800">Pregled Specijala za CSV</h2>
                        
                    </div>
                     
                     <div id="csvPreviewContent" class="space-y-2 max-h-96 overflow-y-auto bg-gray-50 p-3 rounded-md border">
                         
                          <p class="text-gray-500 italic text-center py-4">Nema dodatih specijala za pregled.</p>
                     </div>
                     
                     <div class="mt-6 text-right">
                         <button id="generateCsvButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 disabled:opacity-50" disabled>
                             Generiši CSV za Meč Specijal
                         </button>
                     </div>
                </div>
            </div>
             
             <div id="errorContainer" class="hidden text-center text-red-500 p-4 bg-red-100 rounded-lg border border-red-300">
                
            </div>
        </main>
    </div>

    
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2"></div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // DOM Elementi
            const loader = document.getElementById('loader');
            const specialsContent = document.getElementById('specialsContent');
            const errorContainer = document.getElementById('errorContainer');
            const matchNameHeader = document.getElementById('matchNameHeader');
            const specialsList = document.getElementById('specialsList'); // Main container
            const calculatedSpecialsContainer = document.getElementById('calculatedSpecialsContainer');
            const calculatedButtonContainer = document.getElementById('calculatedButtonContainer');
            const prepackSpecialsContainer = document.getElementById('prepackSpecialsContainer');
            const prepackButtonContainer = document.getElementById('prepackButtonContainer');
            const csvPreviewContent = document.getElementById('csvPreviewContent');
            const generateCsvButton = document.getElementById('generateCsvButton');
            // Buttons created dynamically now
            let addCalculatedSpecialsButton = null;
            let addPrepackSpecialsButton = null;
            const csvPreviewSectionContainer = document.getElementById('csvPreviewSectionContainer');

            // Stanje aplikacije
            let allMarkets = [];
            let fetchedData = null;
            let specialsForPreview = [];

            // --- Pomoćne Funkcije ---

            function removeDiacritics(text) {
                 if (!text) return ''; text = text.replace(/đ/g, 'dj').replace(/Đ/g, 'Dj'); return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }

            function roundOdds(oddsStr) {
                 const odd = parseFloat(oddsStr); if (isNaN(odd)) return ''; let roundedOdd; if (odd > 5) { roundedOdd = Math.round(odd / 0.1) * 0.1; } else if (odd > 3.5) { roundedOdd = Math.round(odd / 0.05) * 0.05; } else { roundedOdd = Math.round(odd * 100) / 100; } roundedOdd = Math.max(1.01, roundedOdd); return roundedOdd.toFixed(2);
            }

             function formatLineValue(lineValue, type = 'over') {
                 if (lineValue === null || lineValue === undefined) return ''; const lineNum = parseFloat(lineValue); if (isNaN(lineNum)) return ''; if (lineNum % 1 === 0.5) { return type === 'over' ? `${Math.ceil(lineNum)}+` : `0-${Math.floor(lineNum)}`; } return lineNum.toString();
            }

            function translatePrepackLabel(label) {
                 let originalLabel = label;
                label = label.replace(/Player's shots on target \(Settled using Opta data\)/gi, "Šutevi u okvir gola"); label = label.replace(/Player's shots \(Settled using Opta data\)/gi, "Ukupno šuteva"); label = label.replace(/Player's fouls conceded \(Settled using Opta data\)/gi, "Načinjenih faulova"); label = label.replace(/To Score Or Assist \(Settled using Opta data\)/gi, "Gol ili asistencija"); label = label.replace(/To score or get an assist/gi, "Gol ili asistencija"); label = label.replace(/To Score or Assist/gi, "Gol ili asistencija"); label = label.replace(/To Assist \(Settled using Opta data\)/gi, "Asistencija"); label = label.replace(/To score at least 2 goals/gi, "Daje 2+ gola"); label = label.replace(/To score at least 3 goals/gi, "Daje 3+ gola (Het-trik)"); label = label.replace(/To score from a header/gi, "Daje gol glavom"); label = label.replace(/To score from outside the penalty box/gi, "Daje gol izvan šesnaesterca"); label = label.replace(/Yes Both Teams To Score/gi, "GG"); label = label.replace(/No Both Teams To Score/gi, "NG"); label = label.replace(/Both Teams To Score/gi, "GG"); label = label.replace(/Total Corners/gi, "ukupno kornera"); label = label.replace(/Total Cards/gi, "ukupno kartona"); label = label.replace(/Total Goals/gi, "ukupno golova"); label = label.replace(/Most Corners/gi, "više kornera"); label = label.replace(/Most Cards/gi, "više kartona"); label = label.replace(/To Score/gi, "Daje gol"); label = label.replace(/To Get a Card/gi, "Dobija karton"); label = label.replace(/To Get a Red Card/gi, "Dobija crveni karton"); label = label.replace(/Full Time (.+)/gi, "$1 pobeđuje"); label = label.replace(/(Over|više)\s+([\d.]+)/gi, (match, p1, p2) => formatLineValue(p2, 'over')); label = label.replace(/(Under|manje)\s+([\d.]+)/gi, (match, p1, p2) => formatLineValue(p2, 'under')); return label.replace(/\s+/g, ' ').trim();
            }

            function logError(message) {
                loader.style.display = 'none'; errorContainer.textContent = message; errorContainer.classList.remove('hidden'); specialsContent.classList.add('hidden');
            }

            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container'); const toast = document.createElement('div'); let bgColorClass = 'bg-green-500'; if (type === 'error') bgColorClass = 'bg-red-500'; if (type === 'info') bgColorClass = 'bg-blue-500'; toast.className = `${bgColorClass} text-white text-sm font-bold px-4 py-3 rounded-lg shadow-md mb-2 transition-opacity duration-300 ease-out`; toast.textContent = message; toastContainer.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; }, 2200); setTimeout(() => { toast.remove(); }, 2500);
            }

            // --- Glavna Logika ---

            const params = new URLSearchParams(window.location.search); const eventId = params.get('eventId');
            if (!eventId) { logError("Event ID nije pronađen."); return; }
            const storedData = sessionStorage.getItem(`event_${eventId}`);
            if (storedData) { fetchedData = JSON.parse(storedData); }
            else { logError("Podaci o meču nisu pronađeni."); return; }

            try {
                const eventName = fetchedData.events[0]?.name || "Nepoznat meč";
                matchNameHeader.textContent = `Specijali za meč: ${eventName}`;
                fetchedData.betOffers.forEach(offer => {
                    offer.outcomes.forEach(outcome => {
                        allMarkets.push({ betOfferId: offer.id, marketName: offer.criterion.label, line: (outcome.line !== undefined && outcome.line !== null) ? (outcome.line / 1000) : null, label: outcome.label, odds: (outcome.odds / 1000) });
                    });
                });
                calculateAndDisplaySpecials();
            } catch (error) { logError(`Greška pri obradi podataka: ${error.message}`); return; }

            function getOdd(marketNameIdentifier, line, labelIdentifier) {
                 const marketNameLower = marketNameIdentifier.toLowerCase(); const labelLower = labelIdentifier.toLowerCase();
                 const marketTranslations = { "total goals": "ukupno golova", "total corners": "ukupno kornera", "total cards": "ukupno kartona", "both teams to score": "gg", "penalty kick awarded": "penalty kick awarded", "red card given": "red card given", "total shots on target (settled using opta data)": "total shots on target (settled using opta data)" };
                 const labelTranslations = { "over": "više", "under": "manje", "yes": "yes", "no": "no" };
                 const translatedMarket = marketTranslations[marketNameLower] || marketNameLower; const translatedLabel = labelTranslations[labelLower] || labelLower;
                 const exactMatchTranslated = allMarkets.find(m => m.marketName.toLowerCase() === translatedMarket && m.line === line && m.label.toLowerCase() === translatedLabel); if (exactMatchTranslated) return exactMatchTranslated.odds;
                 const exactMatchRaw = allMarkets.find(m => m.marketName.toLowerCase() === marketNameLower && m.line === line && m.label.toLowerCase() === labelLower); if (exactMatchRaw) return exactMatchRaw.odds;
                 const participants = fetchedData.events[0]?.participants;
                 const looserMatch = allMarkets.find(m => (m.marketName.toLowerCase().includes(translatedMarket) || m.marketName.toLowerCase().includes(marketNameLower)) && !m.marketName.toLowerCase().includes('1st half') && !m.marketName.toLowerCase().includes('2nd half') && !m.marketName.toLowerCase().includes('by team') && (participants?.length !== 2 || (!m.marketName.toLowerCase().includes(`by ${participants[0].name.toLowerCase()}`) && !m.marketName.toLowerCase().includes(`by ${participants[1].name.toLowerCase()}`))) && m.line === line && (m.label.toLowerCase() === translatedLabel || m.label.toLowerCase() === labelLower)); return looserMatch ? looserMatch.odds : null;
            }

            function lambda_from_p_over(p_over, tol = 1e-8, maxiter = 50) {
                 if (p_over <= 0) return 0.1; if (p_over >= 1) return 20; let lam = 2.0;
                 for (let i = 0; i < maxiter; i++) {
                     const exp_neg_lam = Math.exp(-lam); const f = 1 - exp_neg_lam * (1 + lam + (lam * lam) / 2) - p_over; const fp = exp_neg_lam * ((lam * lam) / 2);
                     if (Math.abs(fp) < 1e-12) { lam += (f > 0 ? -tol : tol); if (lam <= 0) lam = tol; continue; } const step = f / fp; lam -= step;
                     if (lam <= 0) { lam = tol; } if (Math.abs(step) < tol) { break; }
                 } return lam > 0 ? lam : 0.1;
            }

            function calculateAndDisplaySpecials() {
                const q_over_2_5 = getOdd("Total Goals", 2.5, "over"); const q_under_2_5 = getOdd("Total Goals", 2.5, "under"); let lam = 2.7;
                if (q_over_2_5 && q_under_2_5) { const p_over_raw = 1.0 / q_over_2_5; const p_under_raw = 1.0 / q_under_2_5; const margin = p_over_raw + p_under_raw; if (margin > 0 && p_over_raw <= margin) { const p_over = p_over_raw / margin; lam = lambda_from_p_over(p_over); } else { logStatus(`Nevalidne kvote za Ukupno Golova 2.5: Više=${q_over_2_5}, Manje=${q_under_2_5}.`, true); } } else { logStatus("Nisu pronađene kvote za Ukupno Golova 2.5.", true); }

                 let specialsToCalculate = [
                    { nameTemplate: "{corners} kornera i GG", lineCorners: 9.5, components: [() => getOdd("Total Corners", 9.5, "over"), () => getOdd("Both Teams To Score", null, "yes")], reduceOdds: true },
                    { nameTemplate: "{shots} suteva u okvir i {goals} golova", lineShots: 9.5, lineGoals: 2.5, components: [() => getOdd("Total Shots on Target (Settled using Opta data)", 9.5, "over"), () => getOdd("Total Goals", 2.5, "over")] },
                    { nameTemplate: "{shots} suteva u okvir i GG", lineShots: 10.5, components: [() => getOdd("Total Shots on Target (Settled using Opta data)", 10.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { nameTemplate: "{corners} kornera i {goals} golova", lineCorners: 14.5, lineGoals: 2.5, components: [() => getOdd("Total Corners", 14.5, "over"), () => getOdd("Total Goals", 2.5, "over")] },
                    { nameTemplate: "{corners} kornera i GG", lineCorners: 14.5, components: [() => getOdd("Total Corners", 14.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { nameTemplate: "{corners} kornera i {goals} golova", lineCorners: 9.5, lineGoals: 2.5, components: [() => getOdd("Total Corners", 9.5, "over"), () => getOdd("Total Goals", 2.5, "over")], reduceOdds: true },
                    { nameTemplate: "{corners} kornera i {goals} golova i {cards} kartona", lineCorners: 8.5, lineGoals: 2.5, lineCards: 3.5, components: [() => getOdd("Total Corners", 8.5, "over"), () => getOdd("Total Goals", 2.5, "over"), () => getOdd("Total Cards", 3.5, "over")] },
                    { nameTemplate: "{goals} golova i {cards} kartona", lineGoals: 2.5, lineCards: 3.5, components: [() => getOdd("Total Goals", 2.5, "over"), () => getOdd("Total Cards", 3.5, "over")] },
                    { nameTemplate: "{goals} golova i {corners} kornera", lineGoals: 2.5, lineCorners: 7.5, components: [() => getOdd("Total Goals", 2.5, "over"), () => getOdd("Total Corners", 7.5, "over")] },
                    { nameTemplate: "{shots} suteva u okvir i GG", lineShots: 8.5, components: [() => getOdd("Total Shots on Target (Settled using Opta data)", 8.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { nameTemplate: "{corners} kornera i GG", lineCorners: 11.5, components: [() => getOdd("Total Corners", 11.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { nameTemplate: "{corners} kornera i {cards} kartona i GG", lineCorners: 8.5, lineCards: 2.5, components: [() => getOdd("Total Corners", 8.5, "over"), () => getOdd("Total Cards", 2.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { nameTemplate: "{corners} kornera i {cards} kartona i GG", lineCorners: 8.5, lineCards: 3.5, components: [() => getOdd("Total Corners", 8.5, "over"), () => getOdd("Total Cards", 3.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { nameTemplate: "{corners} kornera i GG", lineCorners: 7.5, components: [() => getOdd("Total Corners", 7.5, "over"), () => getOdd("Both Teams To Score", null, "yes")] },
                    { nameTemplate: "Penal i crveni karton", components: [() => getOdd("Penalty Kick awarded", null, "yes"), () => getOdd("Red Card given", null, "yes")], multiplier: 0.8 },
                    { nameTemplate: "Penal ili crveni karton", calculation: () => { const oP=getOdd("Penalty Kick awarded",null,"yes"), oR=getOdd("Red Card given",null,"yes"); if(!oP||!oR)return null; const pP=1/oP, pR=1/oR, pPR=(pP*pR)*1.2, pOr=pP+pR-pPR; return (pOr>0&&pOr<=1)?1/pOr:null; }},
                    { nameTemplate: "Izmena postize gol", calculation: () => { const lS=lam*0.15, p=1-Math.exp(-lS); return p>0?1/p:null; }},
                    { nameTemplate: "Gol glavom na mecu", calculation: () => { const lH=lam*0.17, p=1-Math.exp(-lH); return p>0?1/p:null; }},
                    { nameTemplate: "Gol izvan 16m", calculation: () => { const lO=lam*0.12, p=1-Math.exp(-lO); return p>0?1/p:null; }},
                    { nameTemplate: "Gol iz slobodnog udarca", calculation: () => { const lF=lam*0.05, p=1-Math.exp(-lF); return p>0?1/p:null; }},
                ];

                calculatedSpecialsContainer.innerHTML = ''; // Clear previous calculated specials
                prepackSpecialsContainer.innerHTML = ''; // Clear previous prepacks
                calculatedButtonContainer.innerHTML = ''; // Clear buttons
                prepackButtonContainer.innerHTML = '';

                // --- Prikaz Kalkulisanih Specijala ---
                let hasCalculated = false;
                specialsToCalculate.forEach((specialDef, index) => { // Added index for unique ID
                    let finalName = specialDef.nameTemplate;
                    if (specialDef.lineCorners !== undefined) finalName = finalName.replace('{corners}', formatLineValue(specialDef.lineCorners, 'over'));
                    if (specialDef.lineGoals !== undefined) finalName = finalName.replace('{goals}', formatLineValue(specialDef.lineGoals, 'over'));
                    if (specialDef.lineCards !== undefined) finalName = finalName.replace('{cards}', formatLineValue(specialDef.lineCards, 'over'));
                    if (specialDef.lineShots !== undefined) finalName = finalName.replace('{shots}', formatLineValue(specialDef.lineShots, 'over'));
                    finalName = finalName.replace(/\s+/g, ' ').trim();

                    let calculatedOdd = null;
                    try {
                        if (specialDef.components) {
                            const componentOdds = specialDef.components.map(fn => fn());
                            if (componentOdds.every(o => o !== null && o > 1)) {
                                calculatedOdd = componentOdds.reduce((acc, val) => acc * val, 1) * (specialDef.multiplier || 1);
                                if (specialDef.reduceOdds) { calculatedOdd *= 0.9; }
                            }
                        } else if (specialDef.calculation) { calculatedOdd = specialDef.calculation(); }
                        if (calculatedOdd !== null) {
                            calculatedOdd = calculatedOdd * 0.85;
                        }
                    } catch (calcError) { console.error(`Greška: ${finalName}: ${calcError}`); calculatedOdd = null; }

                    const finalOddForDisplayString = roundOdds(calculatedOdd);
                    const oddValue = finalOddForDisplayString;
                     // Generate a more unique ID using index
                    const inputId = `odds-input-calc-${index}-${finalName.replace(/[^a-zA-Z0-9]/g, '-')}`;

                    const div = document.createElement('div');
                    div.setAttribute('data-special-type', 'calculated');
                    div.className = 'flex justify-between items-center p-3 border rounded-lg shadow-sm';
                    div.innerHTML = `
                        <span class="text-gray-800 flex-1 mr-2">${finalName}</span>
                        <div class="flex items-center gap-3 w-auto md:w-1/3 flex-shrink-0">
                            <input type="text" value="${oddValue}" class="odds-input w-20 p-1 border border-gray-300 rounded text-center font-medium focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="N/A" id="${inputId}" ${!oddValue ? 'disabled' : ''}>
                            <button data-name="${finalName}" data-input-id="${inputId}" class="add-special-btn bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600 transition-colors duration-200 ${!oddValue ? 'opacity-50 cursor-not-allowed' : ''}" ${!oddValue ? 'disabled' : ''}>+</button>
                        </div>`;
                    calculatedSpecialsContainer.appendChild(div);
                    if (oddValue) hasCalculated = true; // Mark that at least one calculated special was displayed
                });

                // Add "Add Calculated" button if there were any calculated specials
                if (hasCalculated) {
                     addCalculatedSpecialsButton = document.createElement('button');
                     addCalculatedSpecialsButton.id = 'addCalculatedSpecialsButton';
                     addCalculatedSpecialsButton.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-200';
                     addCalculatedSpecialsButton.textContent = 'Dodaj Kalkulisane u Pregled';
                     addCalculatedSpecialsButton.onclick = () => addSpecialsByType('calculated');
                     calculatedButtonContainer.appendChild(addCalculatedSpecialsButton);
                }


                // --- Prikaz PrePack Specijala ---
                let hasPrepacks = false;
                if (fetchedData.prePacks && fetchedData.prePacks.length > 0) {
                     const separator = document.createElement('div'); separator.className = 'pt-4 mt-6 border-t border-gray-300'; separator.innerHTML = '<h3 class="text-lg font-semibold text-gray-700 mb-2">Pre-Pack Specijali</h3>';
                     prepackSpecialsContainer.appendChild(separator); // Add separator to prepack container

                    fetchedData.prePacks.forEach((pack, packIndex) => { // Added packIndex
                        pack.prePackSelections.forEach((selection, index) => {
                            const odds = (selection.combinations[0].odds.decimal / 1000); if (odds < 1.01 || odds > 40) return;
                            const translatedLabels = selection.label.map(translatePrepackLabel); const marketName = translatedLabels.join(' I ');
                            const finalOddForDisplayString = roundOdds(String(odds));
                            const oddValue = finalOddForDisplayString;
                            // Generate a more unique ID using packIndex and index
                            const inputId = `odds-input-prepack-${packIndex}-${index}-${(selection.selectionId || 'noId')}`;

                            const div = document.createElement('div'); div.setAttribute('data-special-type', 'prepack'); div.className = 'flex justify-between items-center p-3 border rounded-lg bg-indigo-50 shadow-sm';
                            div.innerHTML = `
                                <span class="text-gray-800 flex-1 text-sm mr-2">${marketName}</span>
                                <div class="flex items-center gap-3 w-auto md:w-1/3 flex-shrink-0">
                                    <input type="text" value="${oddValue}" class="odds-input w-20 p-1 border border-gray-300 rounded text-center font-medium focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="N/A" id="${inputId}" ${!oddValue ? 'disabled' : ''}>
                                    <button data-name="${marketName}" data-input-id="${inputId}" class="add-special-btn bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600 transition-colors duration-200 ${!oddValue ? 'opacity-50 cursor-not-allowed' : ''}" ${!oddValue ? 'disabled' : ''}>+</button>
                                </div>`;
                            prepackSpecialsContainer.appendChild(div); // Add prepack to its container
                             if(oddValue) hasPrepacks = true; // Mark that at least one prepack was displayed
                        });
                    });

                    // Add "Add PrePacks" button if there were any prepacks
                    if (hasPrepacks) {
                        addPrepackSpecialsButton = document.createElement('button');
                        addPrepackSpecialsButton.id = 'addPrepackSpecialsButton';
                        addPrepackSpecialsButton.className = 'bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-200';
                        addPrepackSpecialsButton.textContent = 'Dodaj PrePacks u Pregled';
                        addPrepackSpecialsButton.onclick = () => addSpecialsByType('prepack');
                        prepackButtonContainer.appendChild(addPrepackSpecialsButton);
                    }
                }

                loader.style.display = 'none'; specialsContent.classList.remove('hidden');
            }

            // 6. Renderovanje CSV pregleda
            function renderPreview() {
                 if (specialsForPreview.length > 0) { csvPreviewSectionContainer.classList.remove('hidden'); generateCsvButton.disabled = false; }
                 else { csvPreviewSectionContainer.classList.add('hidden'); generateCsvButton.disabled = true; }
                 csvPreviewContent.innerHTML = '';
                 if (specialsForPreview.length === 0) {
                     csvPreviewContent.innerHTML = '<p class="text-gray-500 italic text-center py-4">Nema dodatih specijala za pregled.</p>'; return;
                 }
                 specialsForPreview.forEach((special, index) => {
                     const div = document.createElement('div'); div.className = 'grid grid-cols-[1fr,auto,auto] gap-4 items-center p-2 border-b border-gray-200 last:border-b-0';
                     div.innerHTML = `
                        <input type="text" value="${special.name}" class="w-full p-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" data-index="${index}" data-field="name">
                        <input type="text" value="${special.odds}" class="w-20 p-1 border border-gray-300 rounded text-center focus:ring-1 focus:ring-blue-500 focus:border-blue-500" data-index="${index}" data-field="odds">
                        <button class="remove-special-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none" data-index="${index}" title="Ukloni">&times;</button>`;
                     csvPreviewContent.appendChild(div);
                 });
            }

            // 7. Event Listeneri

            // Dodavanje pojedinačnog specijala - ISPRAVLJENO
            specialsList.addEventListener('click', e => {
                if (e.target.classList.contains('add-special-btn')) {
                    const button = e.target; if (button.disabled) return;
                    const { name, inputId } = button.dataset;
                    const oddsInput = document.getElementById(inputId);
                    // Pročitaj VREDNOST DIREKTNO IZ INPUT POLJA U TRENUTKU KLIKA
                    const oddsValueFromInput = oddsInput.value;

                    // Validacija pročitane vrednosti
                    if (!oddsValueFromInput || isNaN(parseFloat(oddsValueFromInput)) || parseFloat(oddsValueFromInput) < 1.01) {
                        showToast(`Kvota "${oddsValueFromInput}" za "${name}" nije validna (min 1.01).`, "error"); return;
                    }

                    // Provera da li već postoji
                    if (!specialsForPreview.some(s => s.name === name)) {
                        // Sačuvaj tačno pročitanu vrednost (string)
                        specialsForPreview.push({ name, odds: oddsValueFromInput });
                        renderPreview(); showToast(`Dodato: ${name} (${oddsValueFromInput})`);
                    } else { showToast("Market je već dodat.", "info"); }
                }
            });

            // Dodavanje grupe specijala - ISPRAVLJENO
            function addSpecialsByType(type) {
                 let addedCount = 0;
                 // Selektuj SVE add-special-btn unutar kontejnera za dati tip
                 const container = type === 'calculated' ? calculatedSpecialsContainer : prepackSpecialsContainer;
                 const allSpecialButtons = container.querySelectorAll(`.add-special-btn`);

                 allSpecialButtons.forEach(btn => {
                     if (btn.disabled) return; // Preskoči ako je dugme onemogućeno
                     const { name, inputId } = btn.dataset;
                     const oddsInput = document.getElementById(inputId);
                      // Pročitaj VREDNOST DIREKTNO IZ INPUT POLJA U TRENUTKU KLIKA
                     const oddsValueFromInput = oddsInput.value;

                     // Validacija pročitane vrednosti i provera duplikata
                     if (oddsValueFromInput && !isNaN(parseFloat(oddsValueFromInput)) && parseFloat(oddsValueFromInput) >= 1.01 && !specialsForPreview.some(s => s.name === name)) {
                         // Sačuvaj tačno pročitanu vrednost (string)
                         specialsForPreview.push({ name, odds: oddsValueFromInput });
                         addedCount++;
                     }
                 });

                 if (addedCount > 0) { renderPreview(); showToast(`${addedCount} ${type === 'calculated' ? 'kalk.' : 'PrePack'} marketa dodato.`); }
                 else { showToast(`Nema novih ${type === 'calculated' ? 'kalk.' : 'PrePack'} marketa za dodavanje.`, "info"); }
            }
            // Listeneri se dodaju dinamički kada se dugmad kreiraju

            // Uklanjanje iz pregleda
            csvPreviewContent.addEventListener('click', e => {
                  if (e.target.classList.contains('remove-special-btn')) { const index = parseInt(e.target.dataset.index, 10); if (index >= 0 && index < specialsForPreview.length) { specialsForPreview.splice(index, 1); renderPreview(); } }
            });

            // Ažuriranje vrednosti u pregledu
             csvPreviewContent.addEventListener('input', e => {
                 if (e.target.tagName === 'INPUT') { const index = parseInt(e.target.dataset.index, 10); const field = e.target.dataset.field; if (index >= 0 && index < specialsForPreview.length && (field === 'name' || field === 'odds')) { specialsForPreview[index][field] = e.target.value; } }
            });

            // Generisanje finalnog CSV-a
            generateCsvButton.addEventListener('click', () => {
                 if (specialsForPreview.length === 0) return;
                 const header = "Datum,Vreme,Sifra,Domacin,Gost,1,X,2,GR,U,O,Yes,No"; let csvRows = [header];
                 const eventInfo = fetchedData.events[0]; if (!eventInfo) { logError("Nema info o događaju.", true); return; }
                 const matchDate = new Date(eventInfo.start);
                 const datum = `${matchDate.getDate().toString().padStart(2, '0')}.${(matchDate.getMonth() + 1).toString().padStart(2, '0')}.${matchDate.getFullYear()}`;
                 const vreme = `${matchDate.getHours().toString().padStart(2, '0')}:${matchDate.getMinutes().toString().padStart(2, '0')}`;
                 csvRows.push('MATCH_NAME:Xtip Specijal'); csvRows.push(`LEAGUE_NAME:${eventInfo.name || 'Nepoznata Liga'}`);

                 specialsForPreview.forEach(special => {
                     const finalOdds = parseFloat(special.odds); // Parsiraj sačuvanu/editovanu vrednost
                     if (!isNaN(finalOdds) && finalOdds >= 1.01) {
                         const row = [datum, vreme, '', special.name, 'DA', finalOdds.toFixed(2), '', '', '', '', '', '', '']; csvRows.push(row.join(','));
                     } else {
                         console.warn(`Preskačem red za "${special.name}" zbog nevalidne kvote: ${special.odds}`); showToast(`Kvota za "${special.name}" (${special.odds}) nije validna (min 1.01) i biće preskočena.`, "error");
                     }
                 });

                 if (csvRows.length <= 3) { showToast("Nema validnih specijala za izvoz.", "error"); return; }
                 const csvContent = csvRows.join('\n');
                 const matchName = removeDiacritics(eventInfo.name || 'nepoznat_mec').replace(/ /g, '_').replace(/vs/ig, '');
                 const fileName = `mec_specijal_${matchName}.csv`;
                 const BOM = "\uFEFF"; const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                 const link = document.createElement('a'); const url = URL.createObjectURL(blob);
                 link.setAttribute('href', url); link.setAttribute('download', fileName); link.style.visibility = 'hidden';
                 document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
                 showToast("CSV fajl generisan.", "success");
            });
        });
    </script>
</body>
</html>

